function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var _connectoEventStore={vars:{storageHandle:"_Connecto",maxEvents:1e3,sliceBy:10,maxSize:2e5},getHtmlStorage:function(e){if(this.vars.localStore)return this.vars.localStore;var n=e.getItem(this.vars.storageHandle);if(n)try{return JSON.parse(n)}catch(o){return e.removeItem(this.vars.storageHandle),this.initHtmlStorage(e)}return null},initHtmlStorage:function(e){if(e.getItem(this.vars.storageHandle))return this.getHtmlStorage(e);var n={source:document.referrer,landing_page:document.URL,firstVisitOn:new Date,events:[],identity:{}};return e.setItem(this.vars.storageHandle,JSON.stringify(n)),n},initPersistentStorage:function(){return this.initHtmlStorage(localStorage)},saveHtmlStorage:function(e,n){try{e.setItem(this.vars.storageHandle,JSON.stringify(n))}catch(o){var t=JSON.stringify(n);t.length>this.vars.maxSize&&n.events.length>this.vars.sliceBy&&(n.events=n.events.slice(this.vars.sliceBy),this.saveHtmlStorage(e,n)),console.log(o)}},savePersistentStorage:function(){this.saveHtmlStorage(localStorage,this.vars.localStore)},prunePayload:function(e){try{var n=JSON.parse(JSON.stringify(e));return delete n.messageId,delete n.userId,delete n.anonymousId,delete n.writeKey,delete n.channel,delete n.sentAt,n.context&&(n.context.url=n.context.url.replace(/^.*\/\/[^\/]+/,""),delete n.context.library),n}catch(o){return null}},addEvent:function(e,n){e.events||(e.events=[]),e.events.push(this.prunePayload(n)),e.events.length>this.vars.maxEvents&&(e.events=e.events.slice(this.vars.sliceBy))},saveEvent:function(e){this.vars.localStore||this.init(),this.addEvent(this.vars.localStore,e),this.savePersistentStorage()},setValue:function(e,n,o){e[n]=o},saveValue:function(e,n){this.vars.localStore||this.init(),this.setValue(this.vars.localStore,e,n),this.savePersistentStorage()},getFromHtmlStorage:function(e){var n=this.getHtmlStorage(localStorage);return n&&n[e]?n[e]:null},init:function(){this.vars.localStore=this.initHtmlStorage(localStorage)}},_connecto=_connecto||[];_connecto.HTML5_PERMISSION_KEY="html5PermissionStatus",_connecto.askedForHtml5Permission=!1,_connecto.trackedHtml5Response=!1,_connecto.closeAfterSubscription=!1;var objAgent=navigator.userAgent,objbrowserName=navigator.appName,objfullVersion=""+parseFloat(navigator.appVersion),objBrMajorVersion=parseInt(navigator.appVersion,10),objOffsetVersion;if(-1!=(objOffsetVersion=objAgent.indexOf("Chrome"))&&(objbrowserName="Chrome",objfullVersion=objAgent.substring(objOffsetVersion+7)),objBrMajorVersion=parseInt(""+objfullVersion,10),isNaN(objBrMajorVersion)&&(objfullVersion=""+parseFloat(navigator.appVersion),objBrMajorVersion=parseInt(navigator.appVersion,10)),!window.Notification||"denied"!==Notification.permission&&"granted"!==Notification.permission||(_connecto.trackedHtml5Response=!0),_connecto.onPushSubscription=function(e,n){var o=e.endpoint;e.subscriptionId&&e.endpoint&&-1===e.endpoint.indexOf(e.subscriptionId)&&(o=e);var t=_connecto.getFromConnectoStorage("pushSubscriptionEndpoint");if(t!=o){_connecto.saveToConnectoStorage("pushSubscriptionEndpoint",o);var c=_connecto.getAnonymousId(),r=_connecto.getFromConnectoStorage("userId");r||(r=c),_connecto.identify(r,{$chromePushDetails:JSON.stringify(e)},null,function(){if(_connecto.trackedHtml5Response||(_connecto.getUrlForUserAction(2),_connecto.trackedHtml5Response=!0,_connecto.pushChomePermissionEventToCassandra(2)),_connecto.closeAfterSubscription&&window.close(),null===_connecto.getFromConnectoStorage(_connecto.HTML5_PERMISSION_KEY)){var e={status:Notification.permission,time:new Date};_connecto.saveToConnectoStorage(_connecto.HTML5_PERMISSION_KEY,e),_connecto.setValueInCookie(_connecto.HTML5_PERMISSION_KEY,JSON.stringify(e)),null!==n&&n()}})}},_connecto.subscribeDevice=function(e,n,o){navigator.serviceWorker.ready.then(function(e){"default"!==Notification.permission||_connecto.askedForHtml5Permission||(_connecto.askedForHtml5Permission=!0,sessionStorage.getItem("haveShownOptInDialog")||(_connecto.getUrlForUserAction(1),_connecto.pushChomePermissionEventToCassandra(1),sessionStorage.setItem("haveShownOptInDialog",!0)));var t={userVisibleOnly:!0};_connecto.VAPIDDetails&&_connecto.VAPIDDetails.publickey&&(t.applicationServerKey=_connecto.urlB64ToUint8Array(_connecto.VAPIDDetails.publickey)),e.pushManager.subscribe(t).then(function(e){_connecto.onPushSubscription(e,n)})["catch"](function(e){if(console.log("Error while subscribing: "+e),"denied"!==Notification.permission||_connecto.trackedHtml5Response||(_connecto.getUrlForUserAction(3),_connecto.trackedHtml5Response=!0,_connecto.pushChomePermissionEventToCassandra(3)),null===_connecto.getFromConnectoStorage(_connecto.HTML5_PERMISSION_KEY)){var n={status:Notification.permission,time:new Date};_connecto.saveToConnectoStorage(_connecto.HTML5_PERMISSION_KEY,n),_connecto.setValueInCookie(_connecto.HTML5_PERMISSION_KEY,JSON.stringify(n)),null!==o&&o()}})})},_connecto.pushForChrome=function(e,n,o){navigator.serviceWorker.register("/serviceworker.js").then(function(){_connecto.subscribeDevice(e,n,o)})["catch"](function(e){console.log(e)})},_connecto.urlB64ToUint8Array=function(e){for(var n="=".repeat((4-e.length%4)%4),o=(e+n).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(o),c=new Uint8Array(t.length),r=0;r<t.length;++r)c[r]=t.charCodeAt(r);return c},_connecto.isPushSupported=function(){return navigator&&navigator.serviceWorker?window.Notification?window.PushManager||navigator&&navigator.push?!0:(console.log("Pushmanager not found."),!1):(console.log("window.Notification not found."),!1):(console.log("Service Workers not supported on this browser. Please upgrade to Chrome 50+"),!1)},_connecto.initPushRegistration=function(e,n,o,t){e&&(_connecto.closeAfterSubscription=!0),_connecto.isPushSupported()&&"Chrome"==objbrowserName&&objBrMajorVersion>=50?_connecto.pushForChrome(e,o,t):null!==n&&n()},_connecto.setSessionDetailsForAsk=function(){sessionStorage.setItem("HTML5_PERMISSION_KEY","true"),_connecto.initPushRegistration()},_connecto.askPermissionViaTimeout=function(e){_connecto.isPushSupported()&&"default"===Notification.permission&&setTimeout(function(){_connecto.setSessionDetailsForAsk()},1e3*e)},_connecto.urlChanged=function(e){var n=sessionStorage.getItem("HTML5_PERMISSION_KEY");if(_connecto.isPushSupported()&&"default"===Notification.permission&&"true"!==n){var o=location.href,t=_connecto.scriptParametersPerProperty.pushAskUrl,c=_connecto.scriptParametersPerProperty.pushAskTime,r=t&&t.value;o&&r&&o.includes(r)&&(c&&c.enabled&&c.value?_connecto.askPermissionViaTimeout(c.value):_connecto.setSessionDetailsForAsk())}},_connecto.addPopStateEventListener=function(){window.addEventListener("popstate",_connecto.urlChanged)},_connecto.decideAskType=function(){var e=_connecto.scriptParametersPerProperty.pushAskUrl,n=_connecto.scriptParametersPerProperty.pushAskTime;return n&&e&&n.enabled&&e.enabled||e&&e.enabled?_connecto.addPopStateEventListener():n&&n.enabled?n.value?_connecto.askPermissionViaTimeout(n.value):function(){}:void 0},_connecto.fetchScriptParams=function(){var e=_connecto.writeKey,n="https://api.connecto.io/getConnectoScriptParams",o={context:{url:document.location.href,library:{name:"connecto.js",version:"1.0"}},properties:{writeKey:e}};fetch(n,{method:"post",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(o)}).then(function(e){e.json().then(function(e){_connecto.scriptParametersPerProperty=e,_connecto.decideAskType()})})["catch"](function(e){console.log(e)})},_connecto.isPushSupported()&&"default"===Notification.permission){var haveAlreadyAskedOnce=sessionStorage.getItem("HTML5_PERMISSION_KEY");"true"!==haveAlreadyAskedOnce&&_connecto.fetchScriptParams()}var _connecto=_connecto||[];_connecto.getConnectoStorage=function(){return _connectoEventStore.getHtmlStorage(localStorage)},_connecto.initConnectoStorage=function(){_connectoEventStore.init()},_connecto.saveToConnectoStorage=function(e,n){_connectoEventStore.saveValue(e,n)},_connecto.getFromConnectoStorage=function(e){return _connectoEventStore.getFromHtmlStorage(e)},_connecto.getAnonymousId=function(){var e=_connecto.getFromConnectoStorage("anonymousId");return _connecto.getFromConnectoStorage("isVerified")?e:null},_connecto.getConnectoId=function(){return _connecto.getFromConnectoStorage("anonymousId")},_connecto.getSessionCount=function(){var e,n=_connecto.getConnectoId();return e=n?2:1},_connecto.pushChomePermissionEventToCassandra=function(e){var n,o;switch(e){case 1:n={userAction:"asked"},o="Push Permission Asked";break;case 2:n={userAction:"allowed"},o="Push Permission Allowed";break;case 3:n={userAction:"denied"},o="Push Permission Denied";break;default:n={}}_connecto.track(o,n,null,function(){})},_connecto.getUrlForUserAction=function(e){var n=function(){setTimeout(function(){_connecto.getUrlForUserAction(e)},1e3)},o=_connecto.getIdentity();if(o instanceof Function&&(o=_connecto.getConnectoId()),null!==o&&""!==o&&o){var t=document.location.protocol+"//push.connecto.io/chromePush/track";t+="?writeKey="+encodeURIComponent(_connecto.writeKey),t+="&actionType="+encodeURIComponent(e),t+="&profileId="+encodeURIComponent(o),t+="&domain="+encodeURIComponent(window.location.origin),fetch(t)}else n()},_connecto.getQueryStringValue=function(e){return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+escape(e).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"))},_connecto.getDefaultPayload=function(e,n){var o=_connecto.getConnectoId();o&&null!==o&&""!==o||(o=guid(),_connecto.saveToConnectoStorage("anonymousId",o),_connecto.saveToConnectoStorage("isVerified",!1));var t=_connecto.getIdentity(),c=n||new Date,r={utm_source:_connecto.getQueryStringValue("utm_source"),utm_medium:_connecto.getQueryStringValue("utm_medium"),utm_campaign:_connecto.getQueryStringValue("utm_campaign"),utm_content:_connecto.getQueryStringValue("utm_content"),utm_term:_connecto.getQueryStringValue("utm_term")};Object.keys(r).forEach(function(e){r[e]&&null!=r[e]||delete r[e]});var i={messageId:guid(),type:e,userId:t,anonymousId:o,timestamp:c,sessioncount:_connecto.getSessionCount(),context:{url:document.location.href,utm_param:r,library:{name:"connecto.js",version:"1.0"}},writeKey:_connecto.writeKey,channel:"web"};return i},_connecto.ajax=function(e){var n=e.url,o=e.type||"POST",t=e.dataType||"text/plain",c=e.withCredentials||!0,r=e.success,i=e.data||null,s=e.headers,a=new XMLHttpRequest;a.open(o,n,!0),a.setRequestHeader("content-type",t);for(var u in s)a.setRequestHeader(u,s[u]);a.withCredentials=c,a.onreadystatechange=function(){r&&4==this.readyState&&200==this.status&&r(this.responseText)},i?a.send(JSON.stringify(i)):a.send()},_connecto._sendIdentifyToServer=function(e,n,o){var t=_connecto.getIdentity();return(o||e&&t&&e===t)&&!_connecto._checkAndUpdateProfileTraits(n,o)?!1:!0},_connecto._checkAndUpdateProfileTraits=function(e,n){var o=_connecto.getFromConnectoStorage("lastTraits")||{};if(n||JSON.stringify(e)!==JSON.stringify(o)){for(var t in e){var c=e[t],r=o[t];r&&r==c&&!n&&delete e[t]}return!0}return!1},_connecto.trackUserIds=function(){try{var e=JSON.parse(localStorage.getItem("MOE_DATA"));if(null===e)return;var n={};if(e.USER_DATA&&e.USER_DATA.attributes){var o=e.USER_DATA.attributes,t=o.filter(function(e){return"USER_ATTRIBUTE_UNIQUE_ID"===e.key}),c=t.length>0?t[0]:{};c.value&&""!==c.value&&(n.moengage_user_id=c.value)}var r=e.HARD_ASK_STATUS,i=e.SUBSCRIPTION_DETAILS;r&&"granted"===r&&i&&i.raw&&(i.keys||i.raw.keys)&&(n.$chromePushDetails=JSON.stringify({endpoint:i.raw.endpoint,expirationTime:i.raw.expirationTime,keys:{p256dh:i.raw.keys?i.raw.keys.p256dh:i.keys.p256dh,auth:i.raw.keys?i.raw.keys.auth:i.keys.auth}})),Object.keys(n).length>0&&_connecto.identify(_connecto.getIdentity(),n,null,function(e){if(e||n.$chromePushDetails&&_connecto.getUrlForUserAction(2),null===_connecto.getFromConnectoStorage(_connecto.HTML5_PERMISSION_KEY)){var o={status:Notification.permission,time:new Date};_connecto.saveToConnectoStorage(_connecto.HTML5_PERMISSION_KEY,o),_connecto.setValueInCookie(_connecto.HTML5_PERMISSION_KEY,JSON.stringify(o))}})}catch(s){}},_connecto.identify=function(e,n,o,t){var c=function(){if(e instanceof Function||!e&&(!n||0===Object.keys(n).length))return void(t&&t());var c=!1;if(o&&o.force&&o.force===!0&&(c=!0),!_connecto._sendIdentifyToServer(e,n,c)||0===Object.keys(n).length){var r=!0;return void(t&&t(r))}e&&_connecto.saveToConnectoStorage("userId",e);var i=_connecto.getDefaultPayload("identify",new Date);i.traits=n,o&&o.url&&(i.context.url=o.url);var s=document.location.protocol+"//api.connecto.io/identify";_connecto._sendAndProcessResponse(s,i,t,_connecto.cbToSetAnonymousId)};e&&null!==e&&""!==e?c():setTimeout(function(){e=_connecto.getIdentity(),_connecto.identify(e,n,o,t)},1e3)},_connecto.setIdentifyCookie=function(e){function n(e,n,o){var t=new Date;t.setTime(t.getTime()+24*o*60*60*1e3);var c="expires="+t.toUTCString();document.cookie=e+"="+n+"; "+c+"; path=/;"}n("identifyCookie",e.identifyCookie,3650)},_connecto.saveTraitsToLocalStorage=function(e){var n=_connecto.getFromConnectoStorage("lastTraits")||{};Object.keys(e).forEach(function(o){n[o]=e[o]}),_connecto.saveToConnectoStorage("lastTraits",n)},_connecto._sendAndProcessResponse=function(e,n,o,t){var c=function(e){if(res=JSON.parse(e),"identify"===n.type){var c=n.traits;_connecto.saveTraitsToLocalStorage(c)}t&&t(res),o&&o(),res.identifyCookie&&_connecto.setIdentifyCookie(res)};n.sentAt=new Date,_connecto.ajax({url:e,data:n,success:c}),_connectoEventStore.saveEvent(n)},_connecto.setValueInCookie=function(e,n){function o(e,n,o){var t=new Date;t.setTime(t.getTime()+24*o*60*60*1e3);var c="expires="+t.toUTCString();document.cookie="_CO_"+e+"="+escape(n)+"; "+c}o(e,n,3650)},_connecto.cbToSetAnonymousId=function(e){if(e.anonymousId){var n=e.anonymousId,o=_connecto.getConnectoId(),t=_connecto.getFromConnectoStorage("isVerified");(n!==o||n===o&&!t)&&(_connecto.saveToConnectoStorage("anonymousId",n),_connecto.setValueInCookie("anonymousId",n),_connecto.setValueInCookie("type","connecto"),_connecto.saveToConnectoStorage("isVerified",!0))}},_connecto.track=function(e,n,o,t){var c=_connecto.getDefaultPayload("track",new Date);c.event=e,c.properties=n,-1!==e.indexOf("Push Permission")&&c&&c.context&&c.context.library&&(c.context.library.name="connecto-backend"),o&&o.url&&(c.context.url=o.url);var r=document.location.protocol+"//api.connecto.io/track";_connecto._sendAndProcessResponse(r,c,t,_connecto.cbToSetAnonymousId)},_connecto.generatedEvents=function(e,n,o,t){var c=_connecto.getDefaultPayload("track",new Date);c.event=e,c.properties=n,-1!==e.indexOf("Push Permission")&&c&&c.context&&c.context.library&&(c.context.library.name="connecto-backend"),o&&o.url&&(c.context.url=o.url);var r=document.location.protocol+"//api.connecto.io/generatedEvents";_connecto._sendAndProcessResponse(r,c,t,_connecto.cbToSetAnonymousId)},_connecto.page=function(e,n,o){var t=_connecto.getDefaultPayload("page",new Date);e&&(t.data=e),n&&n.url&&(t.context.url=n.url);var c=document.location.protocol+"//api.connecto.io/page";_connecto._sendAndProcessResponse(c,t,o,_connecto.cbToSetAnonymousId)},_connecto.onload=function(e){e&&e()},_connecto.processOnLoad=function(){for(var e=_connecto.length,n=0;e>n;n++)_connecto._processPushedFunction(_connecto.shift())},_connecto._processPushedFunction=function(e){var n=e.shift();_connecto[n]&&_connecto[n].apply(null,e)},_connecto.push=function(e){_connecto._processPushedFunction(e)},_connecto.getIdentity=function(){var e=_connecto.getFromConnectoStorage("userId");return(!e||e instanceof Function)&&(e=_connecto.getConnectoId()),e},function(){return _connecto.initialized?void(window.console&&console.error&&console.error("Connecto Snippet Included Twice")):(_connecto.initialized=!0,_connecto.processOnLoad(),void _connecto.initConnectoStorage())}();
